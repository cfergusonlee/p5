---
title: "Enron EDA"
author: "Courtney Ferguson Lee"
date: "6/19/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T,
                      message = F,
                      warning = F)
```

# Introduction

Here I will explore the Enron dataset using EDA, before diving into machine
learning in Python.  I want to get a sense of the underlying datastructure.

```{r Load_Packages}
library(tidyverse)
library(ggplot2)
library(scales) # need to get labels = comma
library(GGally)
```

```{r Load_Data}
getwd()
setwd('/Users/courtneyfergusonlee/p5')
enron <- read.csv('enron_data.csv', 
                  na.strings = 'NaN',
                  stringsAsFactors = F)
```

```{r Reshape_Data}
enron.new_features <- enron %>%
  mutate(fract_to_poi = from_this_person_to_poi/from_messages,
         fract_from_poi = from_poi_to_this_person/to_messages,
         bonus_over_salary = bonus/salary,
         exer_stock_opts_over_tot = exercised_stock_options/total_stock_value,
         poi = as.factor(poi))
```

# Univariate Plots

## Basic Structure

Let's explore some of the underlying structure and variables in the enron
dataset.

```{r}
str(enron.new_features)
```

Looks like it is reading the poi (boolean) variable as a string.  Let's reencode
that.

```{r}
enron$poi <- as.factor(enron$poi)
```

Much better!  Everything else looks in order.

```{r}
dim(enron)
```

```{r}
summary(enron)
```

There are a few values in the summary that are probably worth looking into.  All
variables seem to be widely distributed.  Salary alone has a minimum of 477 and
a maximum of 26,704,229.  That's quite a range.  The same is true for most
variables.  I'll probably have to remove some of these outliers or come up with
some sort of scale to improve the accuracy of my model.  I'll start with a
boxplot for each variable.

```{r}
str(subset(enron, salary > 1000000))
```

## Financial Features

```{r}
ggplot(data = enron,
       aes(x = salary)) +
  geom_histogram(binwidth = 25000) +
  scale_x_continuous(labels = comma)
```

Whoa, that graph is tough to read with that outlier all the way at 26,000,000.
Let's try limiting to just salaries under 1,000,000.

```{r}
ggplot(data = subset(enron,
                     salary < 1000000),
       aes(x = salary / 1000)) +
  geom_histogram(binwidth = 25) +
  scale_x_continuous(breaks = seq(0, 900, 50),
                     labels = comma) +
  ggtitle("Distribution of Salaries") +
  xlab("Salary \n (In 1000's of dollars)") +
  ylab("Frequency")
```

Much better! It looks like the distribution is approximately normally
distributed with a center around $250,000.

```{r}
table(enron$restricted_stock_deferred)
```

```{r}
ggplot(data = enron,
       aes(x = other)) +
  geom_histogram(bins = 60) +
  scale_x_log10(labels = comma,
                breaks = 10^seq(1, 7, 1)) +
  ggtitle('Distribution of "Other" Variable') +
  xlab('Other') +
  ylab('Frequency')
```

The distribution for the "other" variable looks to be bimodal. There is a center
around 400,000 and another around 1000.  It's not clear what this variable
represents.

```{r}
ggplot(data = enron,
       aes(x = total_payments)) +
  geom_histogram(bins = 30) +
  scale_x_log10(labels = comma,
                breaks = 10^seq(2, 8, 1)) +
  ggtitle('Distribution of Total Payments') +
  xlab('Total Payments') +
  ylab('Frequency')
```

The distribution of total payments is normally distributed with a center at
$1,000,000.

```{r}

```

```{r}

```

```{r}

```


## Email Features

I'll take a quick look at the distributions of emails.

```{r}
ggplot(data = enron,
       aes(x = from_this_person_to_poi + 1)) +
  geom_histogram(bins = 40) +
  scale_x_log10(limits = c(1, 1000),
                breaks = 10^seq(1, 4, 1)) +
  ggtitle("Distribution of Emails from this Person to a POI") +
  xlab("Number of Emails from this Person to a POI") +
  ylab("Frequency")
```

```{r}
ggplot(data = enron,
       aes(x = from_poi_to_this_person)) +
  geom_histogram(binwidth = 10) +
  ggtitle("Distribution of Emails from this Person to a POI") +
  xlab("Number of Emails from this Person to a POI") +
  ylab("Frequency")
```

```{r}
ggplot(data = enron,
       aes(x = from_messages + 1)) +
  geom_histogram(bins = 40) +
  scale_x_log10(breaks = 10^seq(1, 4, 1)) +
  ggtitle("Distribution of Emails from this Person to a POI") +
  xlab("Number of Emails from this Person to a POI") +
  ylab("Frequency")
```

```{r}
ggplot(data = enron,
       aes(x = shared_receipt_with_poi + 1)) +
  geom_histogram(bins = 40) +
  scale_x_log10() +
  ggtitle("Distribution of Emails from this Person to a POI") +
  xlab("Number of Emails from this Person to a POI") +
  ylab("Frequency")
```

```{r}
ggplot(data = enron,
       aes(x = to_messages + 1)) +
  geom_histogram(bins = 40) +
  scale_x_log10() +
  ggtitle("Distribution of Outgoing Emails") +
  xlab("Number of Outgoing Emails") +
  ylab("Frequency")
```


```{r}
ggplot(data = enron.new_features,
       aes(x = fract_to_poi)) +
  geom_histogram() +
  
  ggtitle("Distribution of Fractions of Emails from this Person to a POI") +
  xlab("Number of Emails from this Person to a POI") +
  ylab("Frequency")
```


```{r}
ggplot(data = enron.new_features,
       aes(x = fract_from_poi)) +
  geom_histogram() +
  ggtitle("Distribution of  Fractions of Emails to this Person from a POI") +
  xlab("Number of Emails from this Person to a POI") +
  ylab("Frequency")
```


# Bivariate Plots

## Financial Data

```{r Financial_long_form}
financial_long <- enron %>%
  mutate(deferred_income = -deferred_income,
         restricted_stock_deferred = -restricted_stock_deferred) %>%
  select(expenses,
         other,
         director_fees,
         restricted_stock_deferred,
         deferred_income,
         deferral_payments,
         salary,
         long_term_incentive,
         restricted_stock,
         bonus,
         total_payments,
         total_stock_value,
         exercised_stock_options,
         loan_advances,
         poi) %>%
  gather(financial_var,
         amount,
         -poi) %>%
  mutate(financial_var = as.factor(financial_var))

str(financial_long)
```

For the next graph, I'm going to try to get a boxplot with all of the financial 
data.  I'll have to transform it to long format first.

```{r Financial_Boxplot}
ggplot(data = subset(financial_long, 
                     !is.na(amount) & amount > 0),
       aes(x = reorder(financial_var, 
                       amount, 
                       median),
           y = amount)) +
  geom_boxplot() +
  geom_jitter(aes(color = poi,
                  alpha = .2),
              width = .2,
              size = .7) +
  scale_y_log10(labels = comma,
                breaks = 10^seq(2, 8, 1)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  ggtitle("Distribution of Financial Variables") +
  xlab("Financial Variable") +
  ylab("Amount") +
  guides(alpha = 'none')

```

The director_fees and restricted_stock_deferred variables offer a lot of
insight. If either of those variables are non_zero, it indicates fraud.  I 
why this would be true.  I'll have to eventually research the variables in this
dataset.

## Email Data

```{r}
email_long <- enron %>%
  select(to_messages,
         shared_receipt_with_poi,
         from_messages,
         from_this_person_to_poi,
         from_poi_to_this_person,
         poi) %>%
  gather(email_feature,
         amount,
         -poi) %>%
  mutate(email_feature = as.factor(email_feature))

str(email_long)
```

The first thing we'll need to do is create a long form of the email variables.

```{r}
ggplot(data = subset(email_long, !is.na(amount)),
       aes(x = reorder(email_feature, amount, median),
           y = amount + 1)) +
  geom_boxplot() +
  geom_jitter(aes(alpha = .2,
                  color = poi),
              width = .2,
              size = .8) +
  scale_y_log10(labels = comma,
                breaks = c(0,
                           10,
                           100,
                           1000,
                           10000)) +
  ggtitle('Distribution of Emails') +
  xlab('Email Feature') +
  ylab('Number of Messages') +
  guides(alpha = 'none')
```

## Colored Email Distributions for POI vs Non-POI

```{r}
ggplot(data = enron,
       aes(x = shared_receipt_with_poi + 1)) +
  geom_histogram(bins = 50,
                 aes(fill = poi)) +
  scale_x_log10() +
  ggtitle("Distribution of Emails from this Person to a POI") +
  xlab("Number of Emails from this Person to a POI") +
  ylab("Frequency")
```


```{r}
ggplot(data = enron,
       aes(x = from_this_person_to_poi + 1)) +
  geom_histogram(bins = 40,
                 aes(fill = poi)) +
  scale_x_log10(limits = c(1, 1000),
                breaks = 10^seq(1, 4, 1)) +
  ggtitle("Distribution of Emails from this Person to a POI") +
  xlab("Number of Emails from this Person to a POI") +
  ylab("Frequency")
```

```{r}
ggplot(data = enron,
       aes(x = from_poi_to_this_person)) +
  geom_histogram(binwidth = 10,
                 aes(fill = poi)) +
  ggtitle("Distribution of Emails from this Person to a POI") +
  xlab("Number of Emails from this Person to a POI") +
  ylab("Frequency")
```

```{r}
ggplot(data = enron,
       aes(x = from_messages + 1)) +
  geom_histogram(bins = 40,
                 aes(fill = poi)) +
  scale_x_log10(breaks = 10^seq(1, 4, 1)) +
  ggtitle("Distribution of Emails from this Person to a POI") +
  xlab("Number of Emails from this Person to a POI") +
  ylab("Frequency")
```

```{r}
ggplot(data = enron,
       aes(x = shared_receipt_with_poi + 1)) +
  geom_histogram(bins = 40,
                 aes(fill = poi)) +
  scale_x_log10() +
  ggtitle("Distribution of Emails from this Person to a POI") +
  xlab("Number of Emails from this Person to a POI") +
  ylab("Frequency")
```

```{r}
ggplot(data = enron,
       aes(x = to_messages + 1)) +
  geom_histogram(bins = 40,
                 aes(fill = poi)) +
  scale_x_log10() +
  ggtitle("Distribution of Outgoing Emails") +
  xlab("Number of Outgoing Emails") +
  ylab("Frequency")
```


```{r}
ggplot(data = enron.new_features,
       aes(x = fract_to_poi)) +
  geom_histogram(bins = 30,
                 aes(fill = poi)) +
  ggtitle("Distribution of Fractions of Emails to a POI") +
  xlab("Number of Emails from this Person to a POI") +
  ylab("Frequency")
```


```{r}
ggplot(data = enron.new_features,
       aes(x = fract_from_poi)) +
  geom_histogram(bins = 30,
                 aes(fill = poi)) +
  ggtitle("Distribution of  Fractions of Emails from a POI") +
  xlab("Number of Emails from this Person to a POI") +
  ylab("Frequency")
```

# Multivariate Plots

```{r}
ggpairs(subset(enron.new_features, select = -email_address))
```


## Financial Plots

```{r}
ggplot(data = subset(enron.new_features, salary < 10000000),
       aes(x = salary,
           y = bonus,
           color = poi)) +
  geom_point()
```


```{r}
ggplot(data = enron.new_features,
       aes(x = bonus_over_salary,
           y = exer_stock_opts_over_tot,
           color = poi)) +
  geom_point()

names(enron.new_features)
```


## Email Plots

```{r}
ggplot(data = enron.new_features,
       aes(x = fract_to_poi,
           y = fract_from_poi,
           color = poi)) +
  geom_point()
```

